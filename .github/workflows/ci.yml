name: CI Pipeline

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  super-linter:
    name: Lint Code Base
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      statuses: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run Super-Linter
        uses: super-linter/super-linter@v8.3.0
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Enable specific linters
          VALIDATE_EDITORCONFIG: true
          VALIDATE_BASH: true
          VALIDATE_BASH_EXEC: true
          VALIDATE_MARKDOWN: true

          # Disable all other linters
          VALIDATE_ALL_CODEBASE: false

          # EditorConfig settings
          EDITORCONFIG_FILE_NAME: .editorconfig-checker.json

          # ShellCheck configuration
          BASH_FILE_NAME: .shellcheckrc

          # Markdown configuration
          MARKDOWN_CONFIG_FILE: .markdown-lint.yml

          # Filter files
          FILTER_REGEX_EXCLUDE: '(node_modules/|package-lock.json|docs/)'

          # Output settings
          LOG_LEVEL: NOTICE
          SUPPRESS_POSSUM: true

  commitlint:
    name: Lint Commit Messages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Validate Commit Messages
        run: |
          # Get the base and head commits
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Lint all commits in the PR
          npx commitlint --from "${BASE_SHA}" --to "${HEAD_SHA}" --verbose

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [super-linter, commitlint]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run Tests
        run: make test

  build:
    name: Build macOS Package (on Ubuntu)
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install PKG Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libssl-dev zlib1g-dev
          # Install bomutils for mkbom
          git clone https://github.com/hogliux/bomutils.git /tmp/bomutils
          cd /tmp/bomutils && make && sudo make install
          # Install xar for creating the final package
          git clone https://github.com/mackyle/xar.git /tmp/xar
          cd /tmp/xar/xar && \
            ac_cv_lib_crypto_OpenSSL_add_all_ciphers=yes ./autogen.sh && \
            make && sudo make install
          sudo ldconfig

      - name: Build macOS PKG Package
        run: make pkg-ubuntu
