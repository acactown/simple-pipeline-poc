name: Release Pipeline

# IMPORTANT: For this workflow to work, you must configure the following in your repository:
#
# 1. Settings → Actions → General → Workflow permissions:
#    - Select "Read and write permissions"
#    - Check "Allow GitHub Actions to create and approve pull requests"
#
# 2. Create a Personal Access Token (PAT) or GitHub App token:
#    - Go to Settings → Developer settings → Personal access tokens → Fine-grained tokens
#    - Create a token with permissions: Contents (Read/Write), Pull Requests (Read/Write)
#    - Add the token as a repository secret named "RELEASE_PLEASE_TOKEN"
#    - This allows CI workflows to run on release-please PRs (GITHUB_TOKEN won't trigger them)

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run Tests
        run: make test

  build:
    name: Build macOS Package (on Ubuntu)
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install PKG Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libssl-dev zlib1g-dev
          # Install bomutils for mkbom
          git clone https://github.com/hogliux/bomutils.git /tmp/bomutils
          cd /tmp/bomutils && make && sudo make install
          # Install xar for creating the final package
          git clone https://github.com/mackyle/xar.git /tmp/xar
          cd /tmp/xar/xar && \
            ac_cv_lib_crypto_OpenSSL_add_all_ciphers=yes ./autogen.sh && \
            make && sudo make install
          sudo ldconfig

      - name: Build macOS PKG Package
        run: make pkg-ubuntu

      - name: Upload PKG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-pkg
          path: build/*.pkg
          retention-days: 5

  release-please:
    name: Release
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Run Release Please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          # Release type for the project
          release-type: node

          # Token for creating releases and PRs
          # Using PAT instead of GITHUB_TOKEN to trigger CI workflows on created PRs
          token: ${{ secrets.RELEASE_PLEASE_TOKEN }}

          # Optional: Set target branch (default is main)
          target-branch: main

      # Optional: Add additional steps that run only when a release is created
      - name: Checkout Code
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/checkout@v5

      - name: Download PKG Artifact
        if: ${{ steps.release.outputs.release_created }}
        uses: actions/download-artifact@v4
        with:
          name: macos-pkg
          path: build/

      - name: Upload PKG to Release
        if: ${{ steps.release.outputs.release_created }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ steps.release.outputs.tag_name }} build/*.pkg --clobber

      # Output release information for debugging/logging
      - name: Output Release Information
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag name: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}"
          echo "Release URL: ${{ steps.release.outputs.html_url }}"
